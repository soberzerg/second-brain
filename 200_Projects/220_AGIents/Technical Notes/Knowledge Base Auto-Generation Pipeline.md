---
date: 2026-02-05
project: AGIents.pro
component: Knowledge Base Agent
status: MVP Complete (с багами)
tags: [technical, architecture, pipeline, deduplication]
---

# Агент автоматического создания базы знаний

## Статус

✅ **MVP практически завершён**
⚠️ **Известная проблема:** Дедупликация работает некорректно из-за асинхронности

## Архитектура пайплайна

### Этап 1: Парсинг сайта
- Входные данные: URL сайта
- Результат: набор страниц для обработки

### Этап 2: Обработка страниц
Каждая страница обрабатывается индивидуально:

1. **Разбиение на чанки (chunks)**
   - Страница делится на смысловые фрагменты

2. **Фильтрация мусора**
   - Небольшие чанки отсеиваются
   - Удаление нерелевантного контента

### Этап 3: Обработка чанка

Каждый чанк проходит через следующий pipeline:

```
Chunk → Категоризация → Создание документа → Индексация → Дедупликация
```

#### 3.1 Категоризация
- Проверка существующего дерева директорий
- **Варианты:**
  - Выбор существующей папки для чанка
  - Создание новой папки
- Определение оптимального места размещения

#### 3.2 Создание документа
- Создание markdown-документа на основе чанка
- Размещение в выбранной категории

#### 3.3 Индексация
- Немедленная индексация документа в векторное хранилище
- Делает документ доступным для поиска

#### 3.4 Дедупликация
**Механизм:**
- Выполняется **перед созданием документа**
- Требует наличия уже созданных и проиндексированных документов
- Поиск дубликатов в векторном хранилище с фильтрами:
  - **По папке** — ограничение области поиска
  - **По семантике** — если содержимое достаточно объёмное

**Логика:**
```
IF (существуют проиндексированные документы) THEN
  search_vector_store(
    folder_filter = target_folder,
    semantic_filter = chunk_content,
    threshold = similarity_threshold
  )
  IF (найдены похожие документы) THEN
    skip_creation
  ELSE
    create_document
END IF
```

## Проблема: Асинхронная дедупликация

### Описание проблемы
Из-за асинхронной обработки чанков дедупликация работает некорректно:

1. Несколько чанков обрабатываются параллельно
2. Чанк A проверяет дубликаты → не находит → создаёт документ
3. Чанк B (похожий) проверяет дубликаты **одновременно** → не находит → создаёт документ
4. Результат: оба документа созданы, хотя один является дубликатом

### Корневая причина
**Race condition:** между проверкой дубликатов и индексацией документа

```
Time →
─────────────────────────────────────────
Chunk A: check → [gap] → create → index
Chunk B: check → [gap] → create → index
         ↑                         ↑
         Оба не видят друг друга   Оба проиндексированы
```

### Возможные решения

#### Вариант 1: Синхронная обработка (простой)
```
for chunk in chunks:
  process_chunk(chunk)  # Последовательно
```
**Плюсы:** Гарантированная корректность
**Минусы:** Медленная обработка больших сайтов

#### Вариант 2: Семафор на уровне папки (оптимальный)
```python
async with folder_lock(target_folder):
  duplicates = check_duplicates(chunk, folder)
  if not duplicates:
    create_and_index(chunk, folder)
```
**Плюсы:** Параллелизм + корректность
**Минусы:** Требует координации между воркерами

#### Вариант 3: Пост-обработка дедупликация (pragmatic)
```
1. Создать все документы без проверки
2. Запустить batch deduplication после индексации
3. Удалить дубликаты
```
**Плюсы:** Быстро, просто реализовать
**Минусы:** Временное создание дубликатов

#### Вариант 4: Двухфазная индексация
```
Phase 1: Index all chunks (in-memory)
Phase 2: Check duplicates against complete index
Phase 3: Write only unique documents
```

## Рекомендуемое решение

**Комбинированный подход:**
1. Использовать **Вариант 2** (семафор) для критических папок
2. Использовать **Вариант 3** (пост-обработка) для bulk импорта
3. Добавить флаг `dedup_strategy` в конфигурацию агента

## Следующие шаги

- [ ] Реализовать один из вариантов решения race condition
- [ ] Добавить метрики: сколько дубликатов обнаружено/предотвращено
- [ ] Протестировать на большом сайте (100+ страниц)
- [ ] Добавить UI для просмотра прогресса дедупликации
- [ ] Документировать API для конфигурации dedup_strategy

## Связанные документы

- Daily Review 2026-02-05
- Voice note: технические детали (19:45)
- Voice note: прогресс по MVP (20:28)

---

*Техническая документация создана на основе голосовых заметок от 2026-02-05*
