# TG Claude Code Assistant - Masterplan

## Обзор приложения

Telegram-бот, который является мобильным интерфейсом к Claude Code, работающему на VPS. Не обычный чат-бот с API — а полноценный доступ к ИИ-агенту со всеми его инструментами, скиллами и базой знаний. Позволяет управлять задачами, заметками, проектами и общаться с Claude прямо из Telegram — на ходу, без SSH и компьютера.

**Для кого:** Сергей + ассистент (2 пользователя)
**Проблема:** Нет мобильного доступа к Claude Code и единой точки входа для задач/заметок/планирования

## Цели и задачи

- Мобильный доступ к Claude Code со всеми MCP-серверами и скиллами
- Единая точка входа: задачи (YouGile), заметки (Obsidian), чат с ИИ — всё из Telegram
- Обработка пересылаемого контента: ссылки, сообщения, файлы, голосовые
- Проактивные уведомления: напоминания, дедлайны, дайджесты

## Целевая аудитория

**Основной сегмент:** Соло-фаундер/разработчик с несколькими проектами, которому нужен мобильный ИИ-ассистент

**User Persona:**
- Сергей, 30+ лет, ведёт 3-5 проектов параллельно
- Использует Obsidian как базу знаний, YouGile как таск-трекер
- В дороге хочет быстро накинуть задачу, записать идею, спросить ИИ
- Получает переписки/ссылки которые нужно обработать и сохранить
- Не хочет тратить время на SSH или ждать доступа к компьютеру

## Основные фичи

### MVP (Фаза 1)

1. **Telegram <-> Claude Code мост** - Бот принимает текстовые сообщения из Telegram, передаёт их в Claude Code CLI на VPS, возвращает ответ. Сессии с таймаутом (сохранение контекста диалога).

2. **Работа с Obsidian (second-brain)** - Через Claude Code на VPS: создание заметок, добавление в inbox, чтение заметок, поиск по хранилищу. Синхронизация через git pull/push.

3. **Работа с YouGile** - Создание задач, просмотр досок, обновление статусов — через MCP-сервер YouGile, подключённый к Claude Code.

4. **Чат с ИИ** - Вопросы, брейншторм, анализ — полноценный диалог с Claude, который знает контекст всех проектов (CLAUDE.md).

5. **Авторизация по Telegram ID** - Whitelist из 2 user ID (Сергей + ассистент). Остальные получают "доступ запрещён".

6. **Обработка фото и файлов** - Получение фото/документов через Telegram, сохранение на VPS, анализ через Claude (Gemini Vision MCP для изображений).

### Фаза 2 (после валидации)

1. **Голосовые сообщения** - Распознавание голосовых через Whisper API или аналог, передача текста в Claude Code. Режим "надиктовал задачу/заметку".

2. **Пересылка контента с умной обработкой** - Пересылаешь сообщение/ссылку -> бот сам определяет: сохранить как заметку, создать задачу, извлечь контакты, добавить в inbox.

3. **Проактивные уведомления** - Утренний дайджест (задачи на сегодня), напоминания о дедлайнах, еженедельная сводка. Через cron на VPS -> Telegram API.

4. **Команды-шорткаты** - `/tasks` — мои задачи на сегодня, `/inbox` — что в inbox, `/daily` — запустить daily review, `/week` — недельная сводка.

### Будущее развитие

- Мультипользовательский режим с ролевой моделью
- Интеграция с календарём (Google Calendar)
- Голосовой ввод/вывод в реальном времени
- Web-интерфейс как альтернатива Telegram
- Продуктизация: предложить как сервис клиентам AGIency

## Технический стек (рекомендации)

| Компонент | Рекомендация | Альтернативы | Обоснование |
|-----------|-------------|--------------|-------------|
| Бот-сервер | Python (python-telegram-bot) | Node.js (telegraf), Go | Python — быстрый старт, хорошие библиотеки для TG + процессы |
| ИИ-движок | Claude Code CLI (--print mode) | Claude API напрямую | Полный доступ к MCP-серверам, скиллам, файловой системе |
| Хранилище заметок | Git repo (second-brain) | — | Уже есть, синхронизация через git |
| Таск-трекер | YouGile API (через MCP) | — | Уже используется |
| Голосовые | Whisper API (OpenAI) | Deepgram, Google STT | Лучшее качество русского языка |
| Очередь задач | Redis / файловая очередь | RabbitMQ, NATS | Для управления сессиями и очередью сообщений |
| VPS | Текущий VPS с n8n | — | Уже есть инфраструктура |
| Деплой | systemd сервис | Docker, PM2 | Простота для 1 инстанса |

## Архитектура

```
Telegram
   |
   v
[Python TG Bot] ---- авторизация по user_id
   |
   v
[Session Manager] ---- таймаут сессий, очередь сообщений
   |
   v
[Claude Code CLI] ---- --resume для сессий, --print для ответов
   |
   ├── MCP: YouGile
   ├── MCP: Firecrawl
   ├── MCP: Context7
   ├── MCP: Gemini Vision
   ├── MCP: n8n
   ├── Файловая система (second-brain repo)
   └── CLAUDE.md (контекст пользователя)
```

### Ключевые архитектурные решения

1. **Claude Code CLI, а не API** — даёт доступ ко всем MCP-серверам, скиллам, файловой системе. Это то, что делает бота мощнее обычного чат-бота.

2. **--print режим** — Claude Code поддерживает `claude --print` для неинтерактивного использования и `--resume` для продолжения сессий. Это основа взаимодействия.

3. **Session Manager** — хранит mapping: telegram_user_id -> claude_session_id. Таймаут сессии: 15-30 минут бездействия. После таймаута — новая сессия, но CLAUDE.md обеспечивает контекст.

4. **Git sync** — перед каждой сессией `git pull`, после изменений `git add + commit + push`. Автоматически.

## Концептуальная модель данных

### Основные сущности

- **User** - telegram_id, имя, роль (owner/assistant), последняя активность
- **Session** - session_id (Claude Code), telegram_user_id, created_at, last_active, status (active/expired)
- **Message Log** - telegram_message_id, session_id, direction (in/out), content, timestamp, тип (text/voice/photo/file)
- **Notification** - тип, расписание (cron), шаблон, telegram_user_id, active

### Хранение

Минимальная БД — SQLite на VPS для сессий и логов. Основные данные живут в Obsidian (файлы) и YouGile (задачи).

## UI/UX Принципы

- **Telegram-native** — никаких кастомных UI, только текст + inline-кнопки когда нужно
- **Быстрый ввод** — написал текст -> получил результат. Минимум шагов
- **Умный routing** — бот сам определяет что делать: "добавь задачу X" -> YouGile, "запиши идею Y" -> Obsidian inbox, "что думаешь о Z?" -> чат
- **Markdown ответы** — Claude Code отвечает markdown, Telegram поддерживает базовый markdown
- **Длинные ответы** — если ответ > 4096 символов (лимит TG), разбивать на части
- **Референсы:** Notion AI в Telegram, ChatGPT бот, бот Молянова

## Аутентификация и безопасность

- **Метод аутентификации:** Whitelist Telegram user ID в конфиге. Два ID: Сергей + ассистент.
- **Доступ:** Одинаковый для обоих пользователей. Разделение сессий — каждый в своём чате.
- **Защита данных:** VPS с SSH-ключами, git repo приватный, Claude Code Max Plan (данные не используются для обучения).
- **Rate limiting:** Базовый — не более N сообщений в минуту на пользователя, чтобы не спамить Claude Code.

## Этапы разработки

### Этап 1: MVP — Текстовый мост

- [ ] **Установить Claude Code CLI на VPS**
  - ❓ Какая версия Claude Code нужна? (сейчас 0.13.1 локально, но есть 0.14.2)
  - ❓ Какие параметры системы на VPS? (OS, RAM, диск, CPU)
  - ❓ Есть ли API ключ Claude для отдельного инстанса или используем тот же?
  - ❓ Нужна ли отдельная лицензия Claude Code Max Plan для VPS?

- [ ] **Настроить CLAUDE.md и MCP-серверы на VPS (зеркало локальной конфигурации)**
  - ❓ Какие именно MCP-серверы критичны для MVP? (YouGile, Firecrawl, Gemini Vision, n8n, Context7?)
  - ❓ Где хранятся credentials для MCP-серверов? (env vars, конфиг-файлы?)
  - ❓ Нужно ли изменить пути в CLAUDE.md для VPS окружения?
  - ❓ Как организовать безопасное хранение API ключей на VPS?

- [ ] **Клонировать second-brain repo на VPS**
  - ❓ Использовать SSH key или Personal Access Token для git?
  - ❓ В какой директории разместить репозиторий на VPS?
  - ❓ Нужны ли git hooks для автоматизации sync?
  - ❓ Как обрабатывать возможные конфликты при concurrent работе с локального Mac и VPS?

- [ ] **Написать Python Telegram бот с авторизацией по user_id**
  - ❓ Telegram Bot Token — создать новый или есть существующий?
  - ❓ Telegram user ID для Сергея и ассистента — где взять/подтвердить?
  - ❓ Структура проекта бота — где разместить? (в second-brain или отдельный repo?)
  - ❓ Использовать виртуальное окружение Python? Какая версия Python на VPS?

- [ ] **Реализовать вызов `claude --print` из бота**
  - ❓ Как именно работает `claude --print`? Нужна документация/примеры
  - ❓ Поддерживает ли `--print` streaming ответов или только полный ответ?
  - ❓ Как передавать многострочные сообщения и специальные символы?
  - ❓ Timeout для команды — сколько максимум ждать ответа?

- [ ] **Добавить Session Manager (таймаут, --resume)**
  - ❓ Как работает `--resume` в Claude Code? Формат session_id?
  - ❓ Где хранить маппинг telegram_user_id -> claude_session_id? (SQLite, Redis, файл?)
  - ❓ Таймаут сессии — 15 или 30 минут? Нужна ли настройка?
  - ❓ Что делать с expired сессиями — удалять или архивировать логи?

- [ ] **Настроить git sync (auto pull/push)**
  - ❓ Pull перед каждой Claude Code сессией или по расписанию?
  - ❓ Commit message format — автоматический или включать контекст действия?
  - ❓ Push сразу после commit или батчить изменения?
  - ❓ Как обрабатывать merge конфликты автоматически?

- [ ] **Деплой как systemd сервис**
  - ❓ Название сервиса — tg-claude-bot?
  - ❓ User под которым запускать сервис (root / dedicated user)?
  - ❓ Логирование — куда писать логи? (journalctl, отдельный файл?)
  - ❓ Restart policy — always, on-failure?

- [ ] **Тестирование: текстовый чат, задачи в YouGile, заметки в Obsidian**
  - ❓ Тестовые сценарии — есть ли чек-лист функций для проверки?
  - ❓ Тестовый YouGile проект/доска или использовать production?
  - ❓ Как проверить что заметка создалась правильно — вручную через Obsidian?
  - ❓ Критерии "MVP готов" — какие минимальные функции должны работать?

### Этап 2: Медиа и голос

- [ ] **Обработка фото через Telegram API -> сохранение на VPS -> передача в Claude**
  - ❓ Формат хранения фото — оригинал или конвертировать? (JPEG, PNG, WebP)
  - ❓ Путь для хранения — временная директория или постоянная в second-brain?
  - ❓ Размер фото — ограничивать/сжимать перед обработкой?
  - ❓ Gemini Vision MCP — как передавать путь к файлу? Формат вызова?
  - ❓ Очистка старых фото — автоматически или вручную?

- [ ] **Обработка файлов/документов**
  - ❓ Типы файлов — какие поддерживать? (PDF, DOC, TXT, другие?)
  - ❓ Размер файла — максимальный лимит для обработки?
  - ❓ PDF MCP tool — настроен ли, как вызывать?
  - ❓ Куда сохранять обработанные файлы в second-brain структуре?

- [ ] **Интеграция Whisper API для голосовых сообщений**
  - ❓ Использовать OpenAI Whisper API или локальный Whisper?
  - ❓ API key для Whisper — где хранить, есть ли уже?
  - ❓ Формат аудио от Telegram — OGG/OPUS, нужна ли конвертация?
  - ❓ Тарификация Whisper API — лимиты, ограничение по длине голосовых?
  - ❓ Язык распознавания — автоопределение или фиксированный русский?

- [ ] **Умная маршрутизация пересылаемых сообщений**
  - ❓ Как определять intent — через Claude Code или отдельная логика?
  - ❓ Типы intent — задача, заметка, контакт, ссылка, референс?
  - ❓ Forwarded message metadata — доступны ли источник, автор, дата?
  - ❓ Fallback поведение — что делать если intent неясен?

### Этап 3: Проактивность

- [ ] **Cron-задачи для уведомлений (утренний дайджест, дедлайны)**
  - ❓ Время для утреннего дайджеста — во сколько отправлять? (одинаково для обоих?)
  - ❓ Часовой пояс VPS — совпадает с часовым поясом пользователей?
  - ❓ Формат дайджеста — что включать? (задачи на сегодня, дедлайны, календарь?)
  - ❓ Откуда брать данные для дайджеста — YouGile, Obsidian, Calendar?
  - ❓ Как определять дедлайны — только из YouGile или еще откуда-то?
  - ❓ Уведомления за N дней до дедлайна — за сколько предупреждать?

- [ ] **Команды-шорткаты (/tasks, /inbox, /daily, /week)**
  - ❓ `/tasks` — какие задачи показывать? (только сегодня, на неделю, по проектам?)
  - ❓ `/inbox` — показывать содержимое или только количество элементов?
  - ❓ `/daily` — запускает daily-review skill или кастомную логику?
  - ❓ `/week` — запускает weekly-synthesis skill?
  - ❓ Нужны ли дополнительные команды? (/help, /status, /projects?)

- [ ] **Еженедельная сводка**
  - ❓ День и время отправки — когда удобно получать? (воскресенье вечером, понедельник утром?)
  - ❓ Что включать — выполненные задачи, прогресс по проектам, статистика активности?
  - ❓ Использовать weekly-synthesis skill или кастомный отчёт?
  - ❓ Формат — текст, markdown, прикреплённый файл?
  - ❓ Нужна ли кнопка "отложить" или "подробнее" для интерактивности?

## Потенциальные вызовы и решения

| Вызов | Влияние | Предложенное решение |
|-------|---------|---------------------|
| Claude Code CLI медленный ответ (10-30с) | Пользователь ждёт, UX страдает | Отправить "typing..." индикатор, стримить частичные ответы если возможно |
| Лимиты Claude Code Max Plan | При активном использовании двумя людьми можно упереться | Мониторить usage, при приближении к лимиту — уведомить |
| Git конфликты при синхронизации | Данные могут потеряться | Auto-merge стратегия, отдельная ветка для VPS, периодический merge |
| Длинные ответы Claude (>4096 символов) | Telegram обрезает | Разбивать на части, отправлять последовательно |
| Параллельные сообщения от 2 пользователей | Claude Code CLI — один процесс | Очередь сообщений, последовательная обработка (или 2 инстанса CC) |
| Безопасность: VPS с доступом ко всему | Взлом VPS = доступ к данным | SSH-ключи, firewall, минимум открытых портов, регулярные обновления |
| Голосовые на русском | Качество распознавания | Whisper large-v3 — лучший для русского |

## Будущие возможности

- Продуктизация для клиентов AGIency (каждый клиент — свой бот + свой Claude Code)
- Web-интерфейс как альтернатива Telegram
- Интеграция с Google Calendar для планирования
- Голосовой вывод (text-to-speech) для ответов
- Автоматическое создание daily review на основе активности за день
- Интеграция с email (пересылка писем в бота)

---
*Создано с помощью /prd*
