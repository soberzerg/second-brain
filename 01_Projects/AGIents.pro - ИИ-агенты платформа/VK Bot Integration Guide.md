# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ VK Bot API –¥–ª—è AGIents

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞:** 21 —è–Ω–≤–∞—Ä—è 2026
**–ê–≤—Ç–æ—Ä:** AGIents.pro
**–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:** –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É—é—â–∏–µ –ò–ò-–±–æ—Ç–æ–≤ –≤ VK

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä VK Bot API](#1-–æ–±–∑–æ—Ä-vk-bot-api)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#2-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
3. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ VK](#3-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-—Å–æ–æ–±—â–µ—Å—Ç–≤–∞-vk)
4. [–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π: Callback API vs Long Poll](#4-–ø–æ–ª—É—á–µ–Ω–∏–µ-—Å–æ–±—ã—Ç–∏–π-callback-api-vs-long-poll)
5. [–†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏](#5-—Ä–∞–±–æ—Ç–∞-—Å-—Å–æ–æ–±—â–µ–Ω–∏—è–º–∏)
6. [–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –±–æ—Ç–∞](#6-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞-–±–æ—Ç–∞)
7. [–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π](#7-–æ–±—Ä–∞–±–æ—Ç–∫–∞-—Å–æ–±—ã—Ç–∏–π)
8. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#8-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
9. [–ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#9-–ø—Ä–∏–º–µ—Ä—ã-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
10. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–π](#10-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–¥–ª—è-—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–π)
11. [–°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é](#11-—Å—Å—ã–ª–∫–∏-–Ω–∞-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é)

---

## 1. –û–±–∑–æ—Ä VK Bot API

### –ß—Ç–æ —Ç–∞–∫–æ–µ VK Bot

**–ë–æ—Ç** ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–∞, –∏–º–∏—Ç–∏—Ä—É—é—â–∞—è –¥–µ–π—Å—Ç–≤–∏—è —á–µ–ª–æ–≤–µ–∫–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä—É—Ç–∏–Ω–Ω—ã—Ö –∑–∞–¥–∞—á. –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –±–æ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ **—Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤** ‚Äî –ø—Ä–∏–≤—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã VK

| –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------------|----------|
| **–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ** | –î–æ—Å—Ç—É–ø –∫ —Å–≤—è–∑—è–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ |
| **–ú—É–ª—å—Ç–∏–º–µ–¥–∏–∞** | –û–≥—Ä–æ–º–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –∞—É–¥–∏–æ) |
| **–ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å** | –†–∞–±–æ—Ç–∞–µ—Ç –≤ –≤–µ–±, –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö, VK Messenger |
| **–ê—É–¥–∏—Ç–æ—Ä–∏—è** | ~100 –º–ª–Ω –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –º–µ—Å—è—Ü |

### –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–∞—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
- **–î–ª—è —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–π:** –∑–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏—ë–º, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  VK Server  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ AGIents Bot ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   AI/LLM    ‚îÇ
‚îÇ   –≤ VK      ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  (API)      ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   Server    ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   Engine    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

1. **–°–æ–æ–±—â–µ—Å—Ç–≤–æ VK** ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **VK API** ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (api.vk.ru)
3. **–ë–æ—Ç-—Å–µ—Ä–≤–µ—Ä** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∏ –ª–æ–≥–∏–∫–∞
4. **AI Engine** ‚Äî AGIents –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤

### –¢—Ä–µ–±—É–µ–º–∞—è –≤–µ—Ä—Å–∏—è API

> **–í–∞–∂–Ω–æ:** –° 1 –¥–µ–∫–∞–±—Ä—è 2024 –≥–æ–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–∏ API **5.81 –∏ –≤—ã—à–µ**. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **5.199** –∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é.

---

## 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ VK

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ/–≤—ã–±–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- –ì—Ä—É–ø–ø—É
- –ü—É–±–ª–∏—á–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
- –í—Å—Ç—Ä–µ—á—É (–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ)

### –®–∞–≥ 2: –í–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –°–æ–æ–±—â–µ–Ω–∏—è**
2. –í–∫–ª—é—á–∏—Ç—å **–°–æ–æ–±—â–µ–Ω–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞**
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –°–æ–æ–±—â–µ–Ω–∏—è ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –±–æ—Ç–∞**
2. –í–∫–ª—é—á–∏—Ç—å **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–æ–≤**
3. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤–∫–ª—é—á–∏—Ç—å **–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É ¬´–ù–∞—á–∞—Ç—å¬ª**
4. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: **–†–∞–∑—Ä–µ—à–∞—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –≤ –±–µ—Å–µ–¥—ã**

### –®–∞–≥ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ –¥–æ—Å—Ç—É–ø–∞ (Access Token)

1. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚Üí –†–∞–±–æ—Ç–∞ —Å API**
2. –ù–∞–∂–∞—Ç—å **–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á**
3. –û—Ç–º–µ—Ç–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞:
   - `messages` ‚Äî –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
   - `photos` ‚Äî –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
   - `docs` ‚Äî –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - `manage` ‚Äî –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º

> **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞! –ü—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–¥–∞–ª–∏—Ç–µ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.

---

## 4. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π: Callback API vs Long Poll

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Callback API | Bots Long Poll API |
|----------|--------------|-------------------|
| **–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** | VK ‚Üí –í–∞—à —Å–µ—Ä–≤–µ—Ä | –í–∞—à —Å–µ—Ä–≤–µ—Ä ‚Üí VK |
| **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è** | –ü—É–±–ª–∏—á–Ω—ã–π HTTPS endpoint | –¢–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã |
| **SSL** | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω | –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | –î–æ 10 —Å–µ—Ä–≤–µ—Ä–æ–≤ | 1 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ |
| **–ó–∞–¥–µ—Ä–∂–∫–∞** | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ | –î–æ 25 —Å–µ–∫ (wait) |
| **Firewall** | –ù—É–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—ã–π –ø–æ—Ä—Ç | –†–∞–±–æ—Ç–∞–µ—Ç –∑–∞ NAT |

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è AGIents

**–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:** Callback API (–Ω–∞–¥—ë–∂–Ω–µ–µ, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–µ–µ)
**–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** Long Poll API (–ø—Ä–æ—â–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å)

---

## 4.1 Callback API

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

1. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Üí –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚Üí –†–∞–±–æ—Ç–∞ —Å API ‚Üí Callback API**
2. –£–∫–∞–∑–∞—Ç—å URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (HTTPS)
3. –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
5. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å

### –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç VK

```json
{
  "type": "message_new",
  "event_id": "unique_event_id",
  "v": "5.199",
  "object": {
    "message": { ... },
    "client_info": { ... }
  },
  "group_id": 123456
}
```

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞

–ù–∞ **–∫–∞–∂–¥–æ–µ** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:
- HTTP Status: `200`
- Body: `ok`

> –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É, Callback API –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

### –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ (X-Retry-Counter)

–ü—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–µ VK –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã:
1. –ß–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
2. –ß–µ—Ä–µ–∑ 3 –º–∏–Ω—É—Ç—ã
3. –ß–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç
4. –ß–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç
5. –ß–µ—Ä–µ–∑ 1 —á–∞—Å

### –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ (Go)

```go
package main

import (
    "encoding/json"
    "fmt"
    "io"
    "net/http"
)

const (
    ConfirmationToken = "your_confirmation_string"
    AccessToken       = "your_access_token"
    APIVersion        = "5.199"
)

type CallbackEvent struct {
    Type    string          `json:"type"`
    Object  json.RawMessage `json:"object"`
    GroupID int             `json:"group_id"`
    EventID string          `json:"event_id"`
    V       string          `json:"v"`
    Secret  string          `json:"secret"`
}

type MessageNew struct {
    Message    Message    `json:"message"`
    ClientInfo ClientInfo `json:"client_info"`
}

type Message struct {
    ID        int    `json:"id"`
    PeerID    int    `json:"peer_id"`
    FromID    int    `json:"from_id"`
    Text      string `json:"text"`
    Date      int    `json:"date"`
    Payload   string `json:"payload,omitempty"`
}

type ClientInfo struct {
    ButtonActions  []string `json:"button_actions"`
    Keyboard       bool     `json:"keyboard"`
    InlineKeyboard bool     `json:"inline_keyboard"`
    Carousel       bool     `json:"carousel"`
    LangID         int      `json:"lang_id"`
}

func callbackHandler(w http.ResponseWriter, r *http.Request) {
    body, _ := io.ReadAll(r.Body)

    var event CallbackEvent
    json.Unmarshal(body, &event)

    switch event.Type {
    case "confirmation":
        fmt.Fprint(w, ConfirmationToken)
        return

    case "message_new":
        var msgNew MessageNew
        json.Unmarshal(event.Object, &msgNew)

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ AGIents
        go handleMessage(msgNew.Message)

    case "message_event":
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∫–Ω–æ–ø–æ–∫
        go handleCallbackButton(event.Object)
    }

    fmt.Fprint(w, "ok")
}

func main() {
    http.HandleFunc("/callback", callbackHandler)
    http.ListenAndServeTLS(":443", "cert.pem", "key.pem", nil)
}
```

---

## 4.2 Bots Long Poll API

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ Long Poll

```
GET https://api.vk.ru/method/groups.getLongPollServer
?group_id=YOUR_GROUP_ID
&access_token=YOUR_TOKEN
&v=5.199
```

–û—Ç–≤–µ—Ç:
```json
{
  "response": {
    "key": "abc123...",
    "server": "https://lp.vk.com/wh123456",
    "ts": "1"
  }
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

```
GET {server}?act=a_check&key={key}&ts={ts}&wait=25
```

–û—Ç–≤–µ—Ç:
```json
{
  "ts": "2",
  "updates": [
    {
      "type": "message_new",
      "object": { ... },
      "group_id": 123456
    }
  ]
}
```

### –ü—Ä–∏–º–µ—Ä (Python)

```python
import requests
import json

class VKLongPoll:
    def __init__(self, token: str, group_id: int):
        self.token = token
        self.group_id = group_id
        self.api_version = "5.199"
        self.session = requests.Session()

    def get_server(self):
        response = self.session.get(
            "https://api.vk.ru/method/groups.getLongPollServer",
            params={
                "group_id": self.group_id,
                "access_token": self.token,
                "v": self.api_version
            }
        ).json()
        return response["response"]

    def listen(self):
        server = self.get_server()

        while True:
            response = self.session.get(
                server["server"],
                params={
                    "act": "a_check",
                    "key": server["key"],
                    "ts": server["ts"],
                    "wait": 25
                }
            ).json()

            if "failed" in response:
                if response["failed"] == 1:
                    server["ts"] = response["ts"]
                else:
                    server = self.get_server()
                continue

            server["ts"] = response["ts"]

            for update in response.get("updates", []):
                yield update

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
lp = VKLongPoll(token="YOUR_TOKEN", group_id=123456)

for event in lp.listen():
    if event["type"] == "message_new":
        message = event["object"]["message"]
        print(f"New message: {message['text']}")
```

---

## 5. –†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (messages.send)

```
POST https://api.vk.ru/method/messages.send
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|----------|
| `peer_id` | integer | ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è (user_id –∏–ª–∏ 2000000000 + chat_id) |
| `random_id` | integer | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π |
| `message` | string | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤) |
| `access_token` | string | –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ |
| `v` | string | –í–µ—Ä—Å–∏—è API |

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|----------|
| `keyboard` | string | JSON –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã |
| `attachment` | string | –í–ª–æ–∂–µ–Ω–∏—è (photo, doc, audio_message) |
| `template` | string | –ö–∞—Ä—É—Å–µ–ª—å –∏–ª–∏ –¥—Ä—É–≥–æ–π —à–∞–±–ª–æ–Ω |
| `dont_parse_links` | integer | –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–Ω–∏–ø–ø–µ—Ç –¥–ª—è —Å—Å—ã–ª–æ–∫ |
| `disable_mentions` | integer | –û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö |

### –ü—Ä–∏–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ (Go)

```go
func sendMessage(peerID int, text string, keyboard *Keyboard) error {
    params := url.Values{
        "peer_id":      {strconv.Itoa(peerID)},
        "message":      {text},
        "random_id":    {strconv.FormatInt(rand.Int63(), 10)},
        "access_token": {AccessToken},
        "v":            {APIVersion},
    }

    if keyboard != nil {
        kb, _ := json.Marshal(keyboard)
        params.Set("keyboard", string(kb))
    }

    resp, err := http.PostForm(
        "https://api.vk.ru/method/messages.send",
        params,
    )
    if err != nil {
        return err
    }
    defer resp.Body.Close()

    return nil
}
```

### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å –≤–ª–æ–∂–µ–Ω–∏—è–º–∏

```go
// –§–æ—Ä–º–∞—Ç attachment: {type}{owner_id}_{media_id}
// –ü—Ä–∏–º–µ—Ä: photo-123456_789012

params.Set("attachment", "photo-123456_789012,doc-123456_789013")
```

---

## 6. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –±–æ—Ç–∞

### –¢–∏–ø—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä

| –¢–∏–ø | inline | –ú–∞–∫—Å–∏–º—É–º –∫–Ω–æ–ø–æ–∫ | –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ |
|-----|--------|-----------------|--------------|
| –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —á–∞—Ç–∞ | false | 40 (10 —Ä—è–¥–æ–≤ √ó 5) | –ü–æ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ |
| Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ | true | 10 (6 —Ä—è–¥–æ–≤ √ó 5) | –í —Å–æ–æ–±—â–µ–Ω–∏–∏ |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

```json
{
  "one_time": false,
  "inline": false,
  "buttons": [
    [
      {
        "action": {
          "type": "text",
          "label": "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è",
          "payload": "{\"action\": \"book\"}"
        },
        "color": "primary"
      },
      {
        "action": {
          "type": "text",
          "label": "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è",
          "payload": "{\"action\": \"consult\"}"
        },
        "color": "secondary"
      }
    ],
    [
      {
        "action": {
          "type": "callback",
          "label": "–ú–æ–∏ –∑–∞–ø–∏—Å–∏",
          "payload": "{\"action\": \"my_appointments\"}"
        },
        "color": "positive"
      }
    ]
  ]
}
```

### –¢–∏–ø—ã –∫–Ω–æ–ø–æ–∫

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ–ª—è |
|-----|----------|------|
| `text` | –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º label | label, payload |
| `callback` | –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è | label, payload |
| `open_link` | –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É | label, link |
| `location` | –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ | payload |
| `vkpay` | –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ VK Pay | hash |
| `open_app` | –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ | app_id, label, owner_id, hash |

### –¶–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫

| –¶–≤–µ—Ç | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------|-----------|---------------|
| –°–∏–Ω–∏–π | `primary` | –û—Å–Ω–æ–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ |
| –ë–µ–ª—ã–π/—Å–µ—Ä—ã–π | `secondary` | –û–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ |
| –ö—Ä–∞—Å–Ω—ã–π | `negative` | –û—Ç–º–µ–Ω–∞, —É–¥–∞–ª–µ–Ω–∏–µ |
| –ó–µ–ª—ë–Ω—ã–π | `positive` | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, —Å–æ–≥–ª–∞—Å–∏–µ |

### –°–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

```json
{
  "buttons": []
}
```

---

## 7. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –±–æ—Ç–æ–≤

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `message_new` | –ù–æ–≤–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ |
| `message_reply` | –ò—Å—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ |
| `message_edit` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `message_event` | –ù–∞–∂–∞—Ç–∏–µ callback-–∫–Ω–æ–ø–∫–∏ |
| `message_allow` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑—Ä–µ—à–∏–ª —Å–æ–æ–±—â–µ–Ω–∏—è |
| `message_deny` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª —Å–æ–æ–±—â–µ–Ω–∏—è |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ message_new (v5.103+)

```json
{
  "type": "message_new",
  "object": {
    "message": {
      "id": 123,
      "date": 1642345678,
      "peer_id": 123456789,
      "from_id": 123456789,
      "text": "–ü—Ä–∏–≤–µ—Ç! –•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥—É",
      "payload": "{\"command\":\"start\"}"
    },
    "client_info": {
      "button_actions": ["text", "callback", "open_link"],
      "keyboard": true,
      "inline_keyboard": true,
      "carousel": true,
      "lang_id": 0
    }
  },
  "group_id": 123456
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∫–Ω–æ–ø–æ–∫ (message_event)

```json
{
  "type": "message_event",
  "object": {
    "user_id": 123456789,
    "peer_id": 123456789,
    "event_id": "abc123...",
    "payload": {"action": "book_appointment"},
    "conversation_message_id": 456
  },
  "group_id": 123456
}
```

### –û—Ç–≤–µ—Ç –Ω–∞ callback-–∫–Ω–æ–ø–∫—É

```go
func sendMessageEventAnswer(eventID string, userID int, peerID int, eventData EventData) {
    data, _ := json.Marshal(eventData)

    params := url.Values{
        "event_id":     {eventID},
        "user_id":      {strconv.Itoa(userID)},
        "peer_id":      {strconv.Itoa(peerID)},
        "event_data":   {string(data)},
        "access_token": {AccessToken},
        "v":            {APIVersion},
    }

    http.PostForm(
        "https://api.vk.ru/method/messages.sendMessageEventAnswer",
        params,
    )
}

// –¢–∏–ø—ã –æ—Ç–≤–µ—Ç–æ–≤:
// 1. –ü–æ–∫–∞–∑–∞—Ç—å snackbar
eventData := EventData{Type: "show_snackbar", Text: "–ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!"}

// 2. –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
eventData := EventData{Type: "open_link", Link: "https://example.com"}

// 3. –û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
eventData := EventData{Type: "open_app", AppID: 123456}
```

---

## 8. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (Secret Key)

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ **Callback API ‚Üí –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á**. –ë—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:

```json
{
  "type": "message_new",
  "secret": "your_secret_key",
  ...
}
```

–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
```go
if event.Secret != expectedSecret {
    http.Error(w, "Forbidden", http.StatusForbidden)
    return
}
```

### SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è Callback API

1. –°–µ—Ä–≤–µ—Ä–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ CA (–Ω–∞–ø—Ä–∏–º–µ—Ä, Let's Encrypt)
2. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
openssl req -newkey rsa:2048 -sha256 -nodes \
  -keyout vkapi.key -x509 -days 365 -out vkapi.crt \
  -subj "/C=RU/ST=Moscow/L=Moscow/O=AGIents/CN=vkapi"

# –≠–∫—Å–ø–æ—Ä—Ç –≤ PKCS#12
openssl pkcs12 -export -in vkapi.crt -name "VK API" \
  -descert -inkey vkapi.key -out vkapi.p12
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è payload

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø–æ–¥–º–µ–Ω—è—Ç—å payload! –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```go
var allowedActions = map[string]bool{
    "book":        true,
    "consult":     true,
    "cancel":      true,
    "my_records":  true,
}

func validatePayload(payload string) bool {
    var p struct {
        Action string `json:"action"`
    }
    json.Unmarshal([]byte(payload), &p)
    return allowedActions[p.Action]
}
```

---

## 9. –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –±–æ—Ç–∞ (Go + AGIents)

```go
package main

import (
    "bytes"
    "encoding/json"
    "fmt"
    "io"
    "log"
    "math/rand"
    "net/http"
    "net/url"
    "strconv"
    "time"
)

type Config struct {
    ConfirmationToken string
    AccessToken       string
    SecretKey         string
    GroupID           int
    APIVersion        string
    AGIentsEndpoint   string
    AGIentsAPIKey     string
}

var config = Config{
    ConfirmationToken: "your_confirmation_string",
    AccessToken:       "your_vk_access_token",
    SecretKey:         "your_secret_key",
    GroupID:           123456,
    APIVersion:        "5.199",
    AGIentsEndpoint:   "https://api.agients.pro/v1/chat",
    AGIentsAPIKey:     "your_agients_api_key",
}

// VK Types
type CallbackEvent struct {
    Type    string          `json:"type"`
    Object  json.RawMessage `json:"object"`
    GroupID int             `json:"group_id"`
    Secret  string          `json:"secret"`
}

type MessageNewObject struct {
    Message    Message    `json:"message"`
    ClientInfo ClientInfo `json:"client_info"`
}

type Message struct {
    ID      int    `json:"id"`
    PeerID  int    `json:"peer_id"`
    FromID  int    `json:"from_id"`
    Text    string `json:"text"`
    Payload string `json:"payload,omitempty"`
}

type ClientInfo struct {
    ButtonActions  []string `json:"button_actions"`
    Keyboard       bool     `json:"keyboard"`
    InlineKeyboard bool     `json:"inline_keyboard"`
    Carousel       bool     `json:"carousel"`
}

type Keyboard struct {
    OneTime bool       `json:"one_time"`
    Inline  bool       `json:"inline"`
    Buttons [][]Button `json:"buttons"`
}

type Button struct {
    Action ButtonAction `json:"action"`
    Color  string       `json:"color,omitempty"`
}

type ButtonAction struct {
    Type    string `json:"type"`
    Label   string `json:"label,omitempty"`
    Payload string `json:"payload,omitempty"`
    Link    string `json:"link,omitempty"`
}

// AGIents Types
type AGIentsRequest struct {
    AgentID  string `json:"agent_id"`
    UserID   string `json:"user_id"`
    Message  string `json:"message"`
    Channel  string `json:"channel"`
    Metadata map[string]interface{} `json:"metadata,omitempty"`
}

type AGIentsResponse struct {
    Response string `json:"response"`
    Actions  []struct {
        Type string                 `json:"type"`
        Data map[string]interface{} `json:"data"`
    } `json:"actions,omitempty"`
}

func main() {
    rand.Seed(time.Now().UnixNano())

    http.HandleFunc("/vk/callback", callbackHandler)

    log.Println("Starting VK Bot server on :8443")
    log.Fatal(http.ListenAndServeTLS(":8443", "cert.pem", "key.pem", nil))
}

func callbackHandler(w http.ResponseWriter, r *http.Request) {
    body, err := io.ReadAll(r.Body)
    if err != nil {
        http.Error(w, "Bad Request", http.StatusBadRequest)
        return
    }

    var event CallbackEvent
    if err := json.Unmarshal(body, &event); err != nil {
        http.Error(w, "Bad Request", http.StatusBadRequest)
        return
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
    if event.Secret != config.SecretKey {
        http.Error(w, "Forbidden", http.StatusForbidden)
        return
    }

    switch event.Type {
    case "confirmation":
        fmt.Fprint(w, config.ConfirmationToken)
        return

    case "message_new":
        var msgObj MessageNewObject
        json.Unmarshal(event.Object, &msgObj)
        go processMessage(msgObj)

    case "message_event":
        go processCallbackButton(event.Object)
    }

    fmt.Fprint(w, "ok")
}

func processMessage(msgObj MessageNewObject) {
    msg := msgObj.Message
    clientInfo := msgObj.ClientInfo

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—É start
    if msg.Payload == `{"command":"start"}` {
        sendWelcomeMessage(msg.PeerID, clientInfo)
        return
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ AGIents –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ AI
    response := callAGIents(msg)

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞
    var keyboard *Keyboard
    if clientInfo.Keyboard {
        keyboard = buildKeyboard(response, clientInfo)
    }

    sendMessage(msg.PeerID, response.Response, keyboard)
}

func callAGIents(msg Message) AGIentsResponse {
    reqBody := AGIentsRequest{
        AgentID: "dental_clinic_bot",
        UserID:  strconv.Itoa(msg.FromID),
        Message: msg.Text,
        Channel: "vk",
        Metadata: map[string]interface{}{
            "peer_id":    msg.PeerID,
            "message_id": msg.ID,
        },
    }

    jsonBody, _ := json.Marshal(reqBody)

    req, _ := http.NewRequest("POST", config.AGIentsEndpoint, bytes.NewBuffer(jsonBody))
    req.Header.Set("Content-Type", "application/json")
    req.Header.Set("Authorization", "Bearer "+config.AGIentsAPIKey)

    client := &http.Client{Timeout: 30 * time.Second}
    resp, err := client.Do(req)
    if err != nil {
        log.Printf("AGIents error: %v", err)
        return AGIentsResponse{Response: "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."}
    }
    defer resp.Body.Close()

    var agResponse AGIentsResponse
    json.NewDecoder(resp.Body).Decode(&agResponse)

    return agResponse
}

func sendWelcomeMessage(peerID int, clientInfo ClientInfo) {
    text := `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –∫–ª–∏–Ω–∏–∫—É! ü¶∑

–Ø –ø–æ–º–æ–≥—É –≤–∞–º:
‚Ä¢ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º
‚Ä¢ –£–∑–Ω–∞—Ç—å –æ –Ω–∞—à–∏—Ö —É—Å–ª—É–≥–∞—Ö
‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é
‚Ä¢ –£–∑–Ω–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã

–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`

    var keyboard *Keyboard
    if clientInfo.Keyboard {
        keyboard = &Keyboard{
            OneTime: false,
            Buttons: [][]Button{
                {
                    {Action: ButtonAction{Type: "text", Label: "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º", Payload: `{"action":"book"}`}, Color: "primary"},
                },
                {
                    {Action: ButtonAction{Type: "text", Label: "–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã", Payload: `{"action":"services"}`}, Color: "secondary"},
                    {Action: ButtonAction{Type: "text", Label: "–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã", Payload: `{"action":"schedule"}`}, Color: "secondary"},
                },
                {
                    {Action: ButtonAction{Type: "callback", Label: "–ú–æ–∏ –∑–∞–ø–∏—Å–∏", Payload: `{"action":"my_appointments"}`}, Color: "positive"},
                },
            },
        }
    }

    sendMessage(peerID, text, keyboard)
}

func buildKeyboard(response AGIentsResponse, clientInfo ClientInfo) *Keyboard {
    // –õ–æ–≥–∏–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ AGIents
    // –ú–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å nil –µ—Å–ª–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ –Ω—É–∂–Ω–∞
    return nil
}

func processCallbackButton(eventObj json.RawMessage) {
    var event struct {
        UserID               int             `json:"user_id"`
        PeerID               int             `json:"peer_id"`
        EventID              string          `json:"event_id"`
        Payload              json.RawMessage `json:"payload"`
        ConversationMsgID    int             `json:"conversation_message_id"`
    }
    json.Unmarshal(eventObj, &event)

    var payload struct {
        Action string `json:"action"`
    }
    json.Unmarshal(event.Payload, &payload)

    switch payload.Action {
    case "my_appointments":
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º snackbar –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        sendSnackbar(event.EventID, event.UserID, event.PeerID, "–ó–∞–≥—Ä—É–∂–∞—é –≤–∞—à–∏ –∑–∞–ø–∏—Å–∏...")
        // –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    default:
        sendSnackbar(event.EventID, event.UserID, event.PeerID, "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...")
    }
}

func sendMessage(peerID int, text string, keyboard *Keyboard) {
    params := url.Values{
        "peer_id":      {strconv.Itoa(peerID)},
        "message":      {text},
        "random_id":    {strconv.FormatInt(rand.Int63(), 10)},
        "access_token": {config.AccessToken},
        "v":            {config.APIVersion},
    }

    if keyboard != nil {
        kb, _ := json.Marshal(keyboard)
        params.Set("keyboard", string(kb))
    }

    resp, err := http.PostForm("https://api.vk.ru/method/messages.send", params)
    if err != nil {
        log.Printf("Send message error: %v", err)
        return
    }
    defer resp.Body.Close()
}

func sendSnackbar(eventID string, userID, peerID int, text string) {
    eventData, _ := json.Marshal(map[string]string{
        "type": "show_snackbar",
        "text": text,
    })

    params := url.Values{
        "event_id":     {eventID},
        "user_id":      {strconv.Itoa(userID)},
        "peer_id":      {strconv.Itoa(peerID)},
        "event_data":   {string(eventData)},
        "access_token": {config.AccessToken},
        "v":            {config.APIVersion},
    }

    http.PostForm("https://api.vk.ru/method/messages.sendMessageEventAnswer", params)
}
```

---

## 10. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–π

### –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ B2B-–ø–∞—Ä—Ç–Ω—ë—Ä–∞

–î–ª—è —Å–µ—Ç–∏ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

### –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

1. **–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏—ë–º**
   - –í—ã–±–æ—Ä –∫–ª–∏–Ω–∏–∫–∏ (—Ñ–∏–ª–∏–∞–ª–∞)
   - –í—ã–±–æ—Ä –≤—Ä–∞—á–∞/—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
   - –í—ã–±–æ—Ä –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏

2. **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è**
   - –ó–∞ —Å—É—Ç–∫–∏ –¥–æ –ø—Ä–∏—ë–º–∞
   - –ó–∞ 2 —á–∞—Å–∞ –¥–æ –ø—Ä–∏—ë–º–∞
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã/–ø–µ—Ä–µ–Ω–æ—Å–∞

3. **–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏**
   - –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–∏–ø–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã (AI)
   - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∂–∏–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ (–¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏)

4. **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**
   - –£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã
   - –ê–¥—Ä–µ—Å–∞ –∏ –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã
   - –ê–∫—Ü–∏–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏

```json
{
  "one_time": false,
  "buttons": [
    [
      {
        "action": {"type": "text", "label": "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è", "payload": "{\"action\":\"book\"}"},
        "color": "primary"
      },
      {
        "action": {"type": "text", "label": "–ú–æ–∏ –∑–∞–ø–∏—Å–∏", "payload": "{\"action\":\"my_appointments\"}"},
        "color": "secondary"
      }
    ],
    [
      {
        "action": {"type": "text", "label": "–£—Å–ª—É–≥–∏ –∏ —Ü–µ–Ω—ã", "payload": "{\"action\":\"services\"}"},
        "color": "secondary"
      },
      {
        "action": {"type": "text", "label": "–ù–∞—à–∏ –∫–ª–∏–Ω–∏–∫–∏", "payload": "{\"action\":\"clinics\"}"},
        "color": "secondary"
      }
    ],
    [
      {
        "action": {"type": "text", "label": "–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å", "payload": "{\"action\":\"question\"}"},
        "color": "secondary"
      }
    ],
    [
      {
        "action": {"type": "open_link", "label": "–ü–æ–∑–≤–æ–Ω–∏—Ç—å", "link": "tel:+78001234567"},
        "color": "positive"
      }
    ]
  ]
}
```

### –ö–∞—Ä—É—Å–µ–ª—å —É—Å–ª—É–≥

```json
{
  "type": "carousel",
  "elements": [
    {
      "photo_id": "-123456_789012",
      "title": "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —á–∏—Å—Ç–∫–∞",
      "description": "–£–¥–∞–ª–µ–Ω–∏–µ –∑—É–±–Ω–æ–≥–æ –∫–∞–º–Ω—è –∏ –Ω–∞–ª—ë—Ç–∞",
      "buttons": [
        {"action": {"type": "text", "label": "–æ—Ç 3 500 ‚ÇΩ"}}
      ]
    },
    {
      "photo_id": "-123456_789013",
      "title": "–õ–µ—á–µ–Ω–∏–µ –∫–∞—Ä–∏–µ—Å–∞",
      "description": "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –º–µ—Ç–æ–¥—ã",
      "buttons": [
        {"action": {"type": "text", "label": "–æ—Ç 4 000 ‚ÇΩ"}}
      ]
    }
  ]
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π flow:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥—É ‚Üí AGIents
2. AGIents –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã ‚Üí CRM —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –≤—Ä–µ–º—è ‚Üí AGIents —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ CRM
4. CRM –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí AGIents ‚Üí VK –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## 11. –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

### –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è VK

| –†–∞–∑–¥–µ–ª | URL |
|--------|-----|
| –ë–æ—Ç—ã –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤ | https://dev.vk.com/ru/api/bots/overview |
| –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç | https://dev.vk.com/ru/api/bots/getting-started |
| Callback API | https://dev.vk.com/ru/api/callback/getting-started |
| Bots Long Poll API | https://dev.vk.com/ru/api/bots-long-poll/getting-started |
| –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ | https://dev.vk.com/ru/api/bots/development/keyboard |
| –°–æ–±—ã—Ç–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤ | https://dev.vk.com/ru/api/community-events/json-schema |
| –ú–µ—Ç–æ–¥—ã API | https://dev.vk.com/ru/method |
| –í–µ—Ä—Å–∏–∏ API | https://dev.vk.com/ru/reference/versions |

### SDK –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

| –Ø–∑—ã–∫ | –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ | GitHub |
|------|------------|--------|
| PHP | VK PHP SDK | https://github.com/VKCOM/vk-php-sdk |
| Java | VK Java SDK | https://github.com/VKCOM/vk-java-sdk |
| Node.js | node-vk-bot-api | https://github.com/bifot/node-vk-bot-api |
| Python | vk_api | https://github.com/python273/vk_api |
| Go | vk-api (community) | https://github.com/SevereCloud/vksdk |

### –ü—Ä–∏–º–µ—Ä—ã –±–æ—Ç–æ–≤

- PHP Bot Example: https://github.com/VKCOM/bot-example-php
- Java YouTrack Bot: https://github.com/VKCOM/vk-java-sdk/wiki/YouTrack-bot

---

## –ß–µ–∫–ª–∏—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞–Ω–æ/–≤—ã–±—Ä–∞–Ω–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ VK
- [ ] –í–∫–ª—é—á–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
- [ ] –í–∫–ª—é—á–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–æ–≤
- [ ] –ü–æ–ª—É—á–µ–Ω –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞ —Å –Ω—É–∂–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω Callback API –∏–ª–∏ Long Poll
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ confirmation
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ message_new
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ message_event (callback-–∫–Ω–æ–ø–∫–∏)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –±–æ—Ç–∞
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω AGIents –¥–ª—è AI-–æ—Ç–≤–µ—Ç–æ–≤
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (secret key, HTTPS)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

*–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ AGIents.pro*
*–ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö: –æ–±—Ä–∞—â–∞—Ç—å—Å—è –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É*
