# **RoadMap: Clario Platform V2.0**

Этот документ описывает этапы эволюции платформы из монолита (Django) в микросервисную архитектуру (FastAPI/Python 3.13) с одновременным устранением продуктовых и архитектурных уязвимостей, выявленных в версии 1.0 и улучшением аналитики.

*NoCRM-версия уже написана на необходимом стеке, но без монорепозитория, развивается параллельно, и будет перенесена в монорепо на одном из финальных этапов миграции.*

*Ещё один компонент платформы — готовые наработки Golang-микросервисов, которые будут дорабатываться под нужды проекта.*

## **Этап 1: Фундамент и Инфраструктура (Week 1\)**

**Цель:** Подготовить среду для разработки, CI/CD и базовые библиотеки, устранив хаос в управлении зависимостями и конфигурациями.

### **1.1. Инициализация Монорепозитория (uv workspaces)**

* Настройка структуры проекта согласно спецификации (Apps vs Libs).  
* Настройка pyproject.toml для workspace.  
* Настройка линтеров (Ruff) и типизации (MyPy) с жесткими правилами.  
* **Решение проблемы:** Устранение "Технического долга" и несогласованности кода на старте.

### **1.2. Базовые библиотеки (Shared Kernels)**

* **libs/core**: Логирование (Logfire), обработка исключений, базовые Pydantic модели.  
* **libs/database**: Асинхронный Session Manager (SQLAlchemy 2.0 \+ asyncpg).  
* **libs/security**: Интеграция с HashiCorp Vault.  
  * **Решение проблемы безопасности:** *Токены хранятся в открытом виде*. Внедрение шифрования и безопасного хранения секретов (Vault) на уровне архитектуры.

### **1.3. Infrastructure as Code**

* Развертывание HashiCorp Consul (Service Discovery).  
* Развертывание HashiCorp Vault (Secret Management).  
* Настройка Docker Compose для локальной разработки с полной изоляцией. 

### **1.4. Работа над промтами (параллельно)**

* Улучшение аналитических промтов (R\&D).

### **1.5. NoCRM-версия (параллельно, здесь и далее)**

* Интеграция Wappi для сбора переписок из чатов.  
* Реализация алертов по флагам на почту руководителю/тимлидам.

## **Этап 2: Core Domain & Auth (Weeks 2-3)**

**Цель:** Создать первые микросервисы и перенести управление пользователями и компаниями, внедрив правильную безопасность.

### **2.1. Auth Service — микросервисы на Golang**

* Реализация JWT авторизации.  
* Управление пользователями, компаниями и правами доступа (IAM, Tenants, RBAC).  
* **Решение проблемы безопасности:** *Недостаточное логирование безопасности*. Внедрение Audit Logging для всех действий входа и изменения прав. *(низкий приоритет)*

### **2.2. BFF на Golang / API Gateway (Entry Point)**

* Настройка маршрутизации запросов к сервисам.  
* **Решение проблемы процессов:** *Неполная API документация*. Автоматическая агрегация OpenAPI схем (Swagger) со всех микросервисов в единую точку.  
* **Решение проблемы безопасности:** *Отсутствие Rate Limiting*. Внедрение лимитов запросов на уровне Gateway для защиты от DDoS и злоупотреблений. *(низкий приоритет)*

## **Этап 3: CRM Integration Service (Week 2\)**

**Цель:** Выделить интеграции в отдельный домен, исправив проблемы "Божественных объектов" и безопасности токенов.

### **3.1. Рефакторинг архитектуры интеграций**

* Создание строгих интерфейсов (Protocols) для CRM-адаптеров.  
* **Решение проблемы архитектуры:** *Смешение ответственности*. Разделение логики получения данных, их нормализации и бизнес-действий. Классы разбиваются на атомарные сервисы.

### **3.2. Миграция Bitrix24 и AmoCRM**

* Перенос логики обновления токенов в Celery/Arq (Async workers).  
* **Решение проблемы стабильности:** *Отсутствие интеграционных тестов*. Написание тестов с использованием аналогов wiremock для имитации ответов CRM.

### **3.3. Работа над промтами**

* Улучшение аналитических промтов (R\&D).

### **3.4. NoCRM-версия**

* Реализация пайплайна по аналитике переписок из чатов.  
* Реализация дашборда аналитики звонков по флагам.

## **Этап 4: Analysis & RAG Service (Week 3\)**

**Цель:** Миграция "мозга" системы с улучшением качества и тестируемости.

### **4.1. LLM Gateway 2.0**

* Реализация унифицированного асинхронного клиента для LLM (OpenAI, Gemini, Anthropic).  
* **Feature Upgrade:** Внедрение A/B тестирования промптов и моделей (сохранение версий промптов и метрик ответов).

### **4.2. RAG Engine**

* Миграция логики работы с Qdrant.  
* Реализация асинхронного chunking и embeddings.  
* **Решение проблемы стабильности:** *Нет mock'ов для внешних сервисов*. Полное покрытие тестами логики RAG без реальных вызовов LLM (использование VCR.py или кастомных моков).

### **4.3. Transcription Service**

* Интеграция с ElevenLabs/AssemblyAI.

### **4.4. Работа над промтами**

* Оптимизация аналитических промтов (R\&D).

### **4.5. NoCRM-версия**

* Реализация нишевой фичи \- распознавание картинок из чата для анализа спроса.  
* Реализация пайплайна по аналитике звонков по скрипту.

## **Этап 5: Analytics (Week 4\)**

**Цель:** Перенос аналитики с архитектурными улучшениями.

### **5.1. Analytics Service**

* Переработка архитектуры аналитических отчётов, для большей гибкости и кастомизируемости под клиента.  
* **Решение проблемы продукта:** *Работа нескольких менеджеров над одной сделкой требует комплексного анализа всех участников*.

### **5.2. Improved Analytics Pipelines**

* Отказоустойчивые, оптимизированные пайплайны.  
* **Решение проблемы архитектуры:** *Хрупкость аналитического пайплайна*. *Ошибка на одном из этапов требует перезапуска процесса целиком.* Разделение процесса на этапы с retry-логикой и кэшированием промежуточных результатов.

### **5.3. Работа над промтами**

* Оптимизация аналитических промтов (R\&D).

### **5.4. NoCRM-версия**

* Реализация нишевой фичи \- распознавание картинок из чата для анализа спроса.  
* Реализация дашборда по аналитике звонков по скрипту.

## **Этап 6: Reporting (Week 5\)**

**Цель:** Перенос отчётов с оптимизацией производительности.

### **5.1. Reporting Service**

* Миграция сложных SQL-запросов (ExtractWeekDay и т.д.) на SQLAlchemy 2.0.  
* **Решение проблемы UX (производительности):** *Нет пагинации*. Внедрение курсорной или page-based пагинации для всех списочных методов по умолчанию.  
* **Решение проблемы UX (производительности):** *Отсутствие кеширования*. Агрессивное кеширование результатов тяжелых агрегаций (Redis) с инвалидацией по событиям. *(низкий приоритет)*

### **5.2. Dashboard & Visualization**

* API для виджетов.

### **5.3. Notification Service (Telegram Bots)**

* Выделение ботов в отдельный сервис.  
* Унификация отправки уведомлений (Telegram, Email, Webhooks).

### **5.3. Работа над промтами (и далее \- постоянная работа над этими задачами)**

* A/B тестирование, оценка промтов.  
* Тестирование различных промтов, моделей (R\&D).

### **5.4. NoCRM-версия**

* Реализация дашборда по аналитике спроса (по картинкам из чатов).  
* Реализация пайплайна по аналитике CRM по регламентам.

## **Этап 7: Observability & Quality Assurance (Week 6-7)**

**Цель:** Обеспечить прозрачность работы системы, которой не хватало в V1.

### **6.1. Распределенный трейсинг**

* Внедрение Logfire/OpenTelemetry во все сервисы.  
* Сквозной трейсинг запроса от Gateway до Database.

### **6.2. Метрики и Мониторинг**

* Экспорт Prometheus метрик (RPS, Latency, Error Rate) из каждого сервиса.  
* Настройка Grafana дашбордов.  
* **Решение проблемы observability:** *Отсутствие Health Checks*. Реализация /health и /ready эндпоинтов с проверкой зависимостей (DB, Redis, Qdrant).

### **6.3. Тестирование**

* Настройка пайплайна с обязательным порогом покрытия (Coverage \> 70%).  
* Написание E2E тестов для критических сценариев (Анализ сделки \-\> Рекомендация).

### **6.4. NoCRM-версия**

* Реализация дашборда по аналитике CRM по регламентам.  
* Мердж NoCRM-версии в монорепо.

Данный RoadMap будет меняться: продуктовым фичам и улучшению аналитики будет отдан самый высокий приоритет.