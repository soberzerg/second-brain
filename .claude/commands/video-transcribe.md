---
description: Транскрибировать локальное видео и создать заметку с расшифровкой и анализом
argument-hint: <путь к видеофайлу или пустое для поиска в 05_Attachments/>
allowed-tools: Bash, Write, Glob, Read, AskUserQuestion
---

# Video Transcribe

Транскрипция локального видеофайла через ffmpeg + OpenAI Whisper API с созданием структурированной заметки в Obsidian.

## Входные данные

**Путь к видео:** $ARGUMENTS

## Задача

### Шаг 1: Валидация и поиск видеофайла

Определи источник видео:

**Если передан путь в $ARGUMENTS:**
1. Проверь что файл существует: `[ -f "$ARGUMENTS" ]`
2. Проверь расширение — поддерживаемые: `.mp4`, `.mov`, `.avi`, `.mkv`, `.webm`, `.m4v`, `.flv`
3. Если файл не найден или формат не поддерживается — сообщи об ошибке с указанием поддерживаемых форматов

**Если $ARGUMENTS пустой:**
1. Найди видеофайлы в `05_Attachments/` используя Glob:
   - `05_Attachments/**/*.mp4`
   - `05_Attachments/**/*.mov`
   - `05_Attachments/**/*.avi`
   - `05_Attachments/**/*.mkv`
   - `05_Attachments/**/*.webm`
   - `05_Attachments/**/*.m4v`
   - `05_Attachments/**/*.flv`
2. Если найден **один файл** — используй его
3. Если найдено **несколько** — покажи список через `AskUserQuestion` с именами и размерами файлов, дай выбрать
4. Если **ни одного** — попроси пользователя указать путь вручную

### Шаг 2: Проверка зависимостей

Перед началом обработки проверь:

1. **ffmpeg:**
```bash
which ffmpeg
```
Если не найден — сообщи: "ffmpeg не установлен. Установи: `brew install ffmpeg`"

2. **OPENAI_API_KEY:**
```bash
echo "${OPENAI_API_KEY:-}"
```
Если пустой — попробуй прочитать из `.env` файла в корне хранилища:
```bash
grep -E '^OPENAI_API_KEY=' .env 2>/dev/null | cut -d'=' -f2-
```
Если всё ещё не найден — сообщи: "OPENAI_API_KEY не настроен. Добавь его в переменные окружения или в файл `.env` в корне хранилища."

### Шаг 3: Извлечение аудио через ffmpeg

Создай временную директорию и извлеки аудио:

```bash
TMPDIR=$(mktemp -d /tmp/video-transcribe-XXXXXX)
ffmpeg -i "<путь_к_видео>" -vn -ar 16000 -ac 1 -ab 128k "$TMPDIR/audio.mp3" -y 2>&1
```

Параметры:
- `-vn` — без видеодорожки
- `-ar 16000` — частота 16kHz (оптимально для речи)
- `-ac 1` — моно (уменьшает размер вдвое)
- `-ab 128k` — битрейт 128kbps

Также получи длительность видео:
```bash
ffprobe -v error -show_entries format=duration -of csv=p=0 "<путь_к_видео>"
```

Если ffmpeg вернул ошибку — покажи вывод ошибки и выполни очистку `rm -rf "$TMPDIR"`.

### Шаг 4: Проверка размера и разбивка

Whisper API имеет лимит 25MB на файл. Проверь размер:

```bash
stat -f%z "$TMPDIR/audio.mp3" 2>/dev/null || stat -c%s "$TMPDIR/audio.mp3" 2>/dev/null
```

**Если размер <= 25000000 байт (25MB):** переходи к Шагу 5, файл = `$TMPDIR/audio.mp3`

**Если размер > 25MB:**

1. Рассчитай количество чанков: `CHUNKS = ceil(размер / 24000000)` (24MB с запасом)
2. Получи длительность: `ffprobe -v error -show_entries format=duration -of csv=p=0 "$TMPDIR/audio.mp3"`
3. Рассчитай длительность чанка: `CHUNK_DURATION = DURATION / CHUNKS`
4. Разбей с overlap 2 секунды:

```bash
for i in $(seq 0 $((CHUNKS-1))); do
  START=$(echo "$i * $CHUNK_DURATION" | bc)
  ffmpeg -i "$TMPDIR/audio.mp3" -ss "$START" -t "$CHUNK_DURATION" -c copy "$TMPDIR/chunk_${i}.mp3" -y 2>&1
done
```

Если отдельный чанк всё ещё >25MB — повтори извлечение аудио с пониженным битрейтом `-ab 64k`.

### Шаг 5: Транскрипция через OpenAI Whisper API

Для каждого аудиофайла (одного или нескольких чанков) выполни запрос:

```bash
curl -s https://api.openai.com/v1/audio/transcriptions \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -F file=@"$TMPDIR/audio.mp3" \
  -F model=whisper-1 \
  -F response_format=verbose_json \
  -F language=ru \
  -o "$TMPDIR/result_0.json"
```

- `response_format=verbose_json` — возвращает сегменты с таймкодами (start, end, text)
- `language=ru` — по умолчанию русский. Если пользователь упоминает что видео на другом языке — замени параметр

Для нескольких чанков нумеруй результаты: `result_0.json`, `result_1.json`, ...

**Обработка ошибок:**
- Проверь что результат содержит поле `"segments"` или `"text"`
- Если содержит `"error"` — покажи сообщение об ошибке (обычно: невалидный ключ, превышен лимит)

### Шаг 6: Склейка и форматирование таймкодов

Извлеки текст с таймкодами из JSON-результатов. Используй python3:

```bash
python3 -c "
import json, sys, os, glob

results = sorted(glob.glob('$TMPDIR/result_*.json'))
offset = 0.0
lines = []

for rfile in results:
    with open(rfile) as f:
        data = json.load(f)
    for seg in data.get('segments', []):
        t = seg['start'] + offset
        h, m, s = int(t//3600), int((t%3600)//60), int(t%60)
        if h > 0:
            ts = f'[{h:02d}:{m:02d}:{s:02d}]'
        else:
            ts = f'[{m:02d}:{s:02d}]'
        lines.append(f'{ts} {seg[\"text\"].strip()}')
    if data.get('segments'):
        offset += data['segments'][-1]['end']

print('\n'.join(lines))
" > "$TMPDIR/transcription.txt"
```

Также собери чистый текст (без таймкодов) для анализа:
```bash
python3 -c "
import json, glob

results = sorted(glob.glob('$TMPDIR/result_*.json'))
for rfile in results:
    with open(rfile) as f:
        data = json.load(f)
    print(data.get('text', ''))
" > "$TMPDIR/plain_text.txt"
```

Прочитай оба файла (`transcription.txt` и `plain_text.txt`) через Read.

### Шаг 7: Генерация выжимки

На основе полного текста транскрипции (plain_text.txt) создай структурированный анализ:

1. **Основная тема** — 1-2 предложения о чём видео
2. **Ключевые тезисы** — 5-10 главных мыслей с пояснениями
3. **Полезные инсайты** — неочевидные выводы
4. **Практические рекомендации** — что можно применить (чекбоксы)
5. **Упомянутые ресурсы** — книги, инструменты, ссылки, эксперты

Требования к анализу:
- Пиши конкретно, без общих фраз
- Сохраняй терминологию автора
- Английские технические термины оставляй как есть
- Если видео техническое — сохраняй точность

### Шаг 8: Форматирование и сохранение

Оформи результат в формате Obsidian-заметки:

```markdown
---
tags:
  - transcription
  - видео
source: "[имя исходного видеофайла]"
date: [YYYY-MM-DD]
duration: "[HH:MM:SS]"
---

# Транскрипция: [Описательное название на основе содержимого]

**Источник:** [имя видеофайла]
**Длительность:** [HH:MM:SS]
**Дата транскрипции:** [YYYY-MM-DD]

## Основная тема

[1-2 предложения]

## Ключевые тезисы

1. **[Тезис 1]** - [пояснение]
2. **[Тезис 2]** - [пояснение]
...

## Полезные инсайты

- [Инсайт 1]
- [Инсайт 2]
...

## Практические рекомендации

- [ ] [Рекомендация 1]
- [ ] [Рекомендация 2]
...

## Упомянутые ресурсы

- **[Ресурс]** - [описание]
...

## Полная транскрипция

[00:00] Первое предложение...
[00:15] Второе предложение...
...

---
*Создано с помощью /video-transcribe*
```

Сохрани файл:
1. Проверь существует ли папка `03_Resources/Transcriptions/` (используй Glob)
2. Имя файла: `03_Resources/Transcriptions/YYYY-MM-DD - [Название].md`
   - Название: описательное, на основе содержимого (или из имени видеофайла)
   - Очисти от спецсимволов: `/ \ : * ? " < > |`
   - Максимум 50 символов, если длиннее — обрежь и добавь `...`

### Шаг 9: Очистка временных файлов

```bash
rm -rf "$TMPDIR"
```

### Шаг 10: Подтверждение

Сообщи пользователю:
- Транскрипция создана
- Путь к сохранённому файлу
- Краткое резюме основной темы
- Длительность видео
- Количество обработанных чанков (если была разбивка)
- Примерная стоимость: ~$0.006 за минуту аудио

## Примеры использования

```
/video-transcribe /path/to/meeting-recording.mp4
/video-transcribe ~/Downloads/interview.mov
/video-transcribe
```

## Важные замечания

- Обработка зависит от длительности видео: ~30 сек на извлечение аудио + ~10-30 сек на транскрипцию каждых 25MB
- Whisper API стоит ~$0.006 за минуту аудио (~$0.36 за 1 час)
- По умолчанию язык — русский. Для другого языка сообщи при запуске
- Видео с музыкой или шумами без речи дадут плохой результат
- Очень длинные видео (2+ часа) будут разбиты на части и обработаны последовательно
- Временные файлы автоматически удаляются после обработки
